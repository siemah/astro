---
import Layout from "../../layouts/Layout.astro";
---

<Layout title={"Panier"}>
  <main class="main-container js-main__container">
    <!-- carousel section -->
    <div
      class="jumbotron jumbotron-fluid p-0 m-0 p-20px carousel-image bg-skyblue overflow-hidden d-flex position-relative"
      style={`min-height: 150px;`}
    >
      <div class="container position-relative">
        <div
          class="h-100 d-flex flex-column justify-content-center align-items-center"
        >
          <h1 class="w-auto px-5 py-3">Panier</h1>
        </div>
      </div>
    </div>
    <!-- end of carousel section -->

    <!-- main content -->
    <div class="container">
      <!-- breadcrumb menu -->
      <nav aria-label="breadcrumb p-1 ">
        <ol class="breadcrumb mb-0 bg-white pt-4 pb-4 border-bottom-grey">
          <li class="breadcrumb-item color-grey" aria-current="page">
            <a class="color-grey" href="/">Home</a>
          </li>
          <li class="breadcrumb-item color-grey" aria-current="page">
            <a class="color-grey" href="/cart/">Mon Panier</a>
          </li>
        </ol>
      </nav>
      <!-- end of breadcrumb menu -->

      <!-- product list  -->
      <div class="row pt-lg-5 pb-5 panier__product-list">
        <div class="col-lg-9 pr-lg-2">
          <table class="table table-theme_black">
            <thead>
              <tr class="border-bottom-black">
                <td scope="col" class="color-grey">Produit</td>
                <td scope="col" class="color-grey">Prix</td>
                <td scope="col" class="color-grey">Quantite</td>
                <td scope="col" class="color-grey">Total</td>
                <td scope="col"></td>
              </tr>
            </thead>
            <tbody class="js-cart-details">
              <tr class="border-bottom-black">
                <td
                  class="align-middle pt-lg-5 pt-sm-3 pb-lg-5 pb-sm-3"
                  scope="row"
                  rowspan="5"
                >
                  <span class="panier__product-item">Chargement...</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="col-lg-3 pl-lg-2">
          <div
            class="card rounded-0 bg-grey pt-4 pb-4 p-4 overflow-hidden mt-5"
          >
            <div class="card-item pt-3 pb-3 align-middle border-bottom-black">
              <div class="p-1 mr-2">Total</div>
              <div
                class="card__highlight bg-white color-green p-1 pl-3 pr-3 rounded-02 bg-grey fs-20 font-weight-bold"
              >
                <span class="js-line-items-total">0</span>
                <sup>DZD</sup>
              </div>
            </div>
            <div class="card-item pt-3 pb-3 align-middle border-bottom-black">
              <div class="p-1 mr-2">TVA 19%</div>
            </div>
            <div class="d-flex card-item pt-3 pb-3 align-middle">
              <div class="p-1 mr-2">Livraison</div>
              <div class="card__highlight p-1 pl-3 pr-3 rounded-02 bg-grey">
                600<sup class="fs-12">DZD</sup>
              </div>
            </div>

            <div class="div pt-3 pb-3">
              <button
                class="btn bg-green color-white btn-block no-border rounded-0 pt-1 pb-1"
                >Commander</button
              >
            </div>
          </div>
        </div>
      </div>
      <!-- end of product list  -->

      <div class="condition-block bg-grey mb-5 p-3">
        <h3 class="display-5 color-black no-underline pr-3">
          Condition general
        </h3>
        <p class="color-light-black pt-4">
          Idque suavitate at vix. Est no soleat aliquip temporibus. Id erat
          accusamus principes vis. Et nec latine meliore antiopam, ne sed
          minimum epicurei accommodare. Vero molestie lobortis mei cu, nam movet
          saperet tacimates te.
        </p>
      </div>
    </div>
    <!-- end main content -->
  </main>
</Layout>
<script>
  import CartStorage from "../../helpers/storage";

  let renderUI = "";
  let lineItemsTotal = 0;
  const cart = new CartStorage();
  const [lineItems = [], products = {}, shippingLines] = await Promise.all([
    cart.getAllItems(),
    cart.getItemsDetails(),
    cart.getShippingLines(),
  ]);
  console.log(lineItems, products, shippingLines);
  // todo: loop over lineitems
  // @ts-ignore
  lineItems?.map((lineItem) => {
    const product = products[lineItem.product_id];
    lineItemsTotal += lineItem?.quantity * product?.regular_price;
    const tr = `
      <tr class="border-bottom-black">
        <td
          class="align-middle pt-lg-5 pt-sm-3 pb-lg-5 pb-sm-3"
          scope="row"
        >
          <img
            src="${product?.thumbnail?.src}"
            alt="${product?.name}"
            width="70px"
          />
          <span class="panier__product-item">${product?.name}</span>
        </td>
        <td class="align-middle pt-lg-5 pt-sm-3 pb-lg-5 pb-sm-3">
          ${product?.regular_price}
          <sup>DZD</sup>
        </td>
        <td class="align-middle pt-lg-5 pt-sm-3 pb-lg-5 pb-sm-3">
          <div
            class="d-flex justify-content-lg-start justify-content-center"
          >
            <div
              class="quantity-container input-group mb-3 mt-2 justify-content-between rounded-0 overflow-hidden"
            >
              <div class="input-group-prepend">
                <button
                  class="input-group-text bg-transparent no-border js-crtl__qty"
                  data-operation="-">-</button
                >
              </div>
              <input
                type="text"
                class="form-control no-border text-center"
                value="${lineItem?.quantity}"
                aria-label="Quantite"
              />
              <div class="input-group-append">
                <button
                  class="input-group-text bg-transparent no-border js-crtl__qty"
                  data-operation="+">+</button
                >
              </div>
            </div>
          </div>
        </td>
        <td class="align-middle pt-lg-5 pt-sm-3 pb-lg-5 pb-sm-3">
          ${lineItem?.quantity * product?.regular_price}
          <sup>DZD</sup>
        </td>
        <td class="align-middle pt-lg-5 pt-sm-3 pb-lg-5 pb-sm-3">
          <button class="bg-transparent no-border">&times;</button>
        </td>
      </tr>
    `;
    renderUI += tr;
  });

  // @ts-ignore
  if (lineItems?.length <= 0) {
    renderUI = `<tr class="border-bottom-black">
      <td
        class="align-middle pt-lg-5 pt-sm-3 pb-lg-5 pb-sm-3"
        scope="row"
        rowspan="5"
      >
          <span class="panier__product-item">Votre panier est vide.</span>
        </td>
    </tr>`;
  }
  // todo: get product details from products object using lineItems?.product_id
  // todo: render items using dom
  const $lineItemsTotal = document.querySelector(".js-line-items-total");
  const $cartBody = document.querySelector(".js-cart-details");
  $lineItemsTotal.textContent = `${lineItemsTotal}`;
  $cartBody.innerHTML = renderUI;
</script>
